<?php
session_start();
require "config.php";
$email = "";
$name = "";
$errors = array();

// Jika pengguna mengklik tombol "check-email" pada formulir lupa kata sandi
if(isset($_POST['check-email'])){
    $email = mysqli_real_escape_string($conn, $_POST['email']);
    $check_email = "SELECT * FROM cake_shop_users_registrations WHERE users_email='$email'";
    $run_sql = mysqli_query($conn, $check_email);
    if(mysqli_num_rows($run_sql) > 0){
        $code = rand(999999, 111111);
        $insert_code = "UPDATE cake_shop_users_registrations SET code = $code WHERE users_email = '$email'";
        $run_query =  mysqli_query($conn, $insert_code);
        if($run_query){
            // Konfigurasi PHPMailer untuk mengirim email
            require 'PHPMailer/PHPMailerAutoload.php';

            $mail = new PHPMailer;
            $mail->isSMTP();
            $mail->Host = 'smtp.gmail.com';
            $mail->Port = 587;
            $mail->SMTPAuth = true;
            $mail->Username = 'your_email@gmail.com'; // Gantilah dengan alamat email Gmail Anda
            $mail->Password = 'your_password'; // Gantilah dengan kata sandi Gmail Anda
            $mail->SMTPSecure = 'tls';

            $mail->setFrom('your_email@gmail.com', 'Your Name'); // Gantilah dengan alamat email dan nama Anda
            $mail->addAddress($email);

            $mail->Subject = 'Password Reset Code';
            $mail->Body = "Your password reset code is $code";

            if($mail->send()){
                $info = "We've sent a password reset otp to your email - $email";
                $_SESSION['info'] = $info;
                $_SESSION['email'] = $email;
                header('location: reset_code.php');
                exit();
            }else{
                $errors['otp-error'] = "Failed while sending code!";
            }
        }else{
            $errors['db-error'] = "Something went wrong!";
        }
    }else{
        $errors['email'] = "This email address does not exist!";
    }
}

// ... (Kode lainnya tetap sama)
?>
